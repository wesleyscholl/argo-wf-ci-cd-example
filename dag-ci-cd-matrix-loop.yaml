metadata:
  name: dag-ci-cd-workflow
  namespace: argo
spec:
  templates:
    - name: e2e-tests
      inputs: {}
      outputs: {}
      metadata: {}
      dag:
        tasks:
          - name: clone-repo
            template: clone-repo
            arguments:
              parameters:
                - name: repo
                  value: "{{workflow.parameters.repo}}"
                - name: branch
                  value: "{{workflow.parameters.branch}}"
          - name: setup-k3s
            template: setup-k3s
            arguments:
              parameters:
                - name: test
                  value: "{{item.test}}"
                - name: install_k3s_version
                  value: "{{item.install_k3s_version}}"
                - name: profile
                  value: "{{item.profile}}"
                - name: use-api
                  value: "{{item.use-api}}"
            withParam: "{{workflow.parameters.test-matrix}}"
            dependencies: [clone-repo]
    - name: clone-repo
      inputs:
        parameters:
          - name: repo
          - name: branch
      outputs: {}
      metadata: {}
      container:
        name: ""
        image: alpine/git:v2.26.2
        args:
          - clone
          - "--depth"
          - "1" # Shallow clone
          - "--branch"
          - '{{=sprig.trimPrefix("refs/heads/",inputs.parameters.branch)}}' # Trims 'refs/heads/' from the webhook payload to the 'main' branch
          - "--single-branch"
          - "{{inputs.parameters.repo}}" # https://github.com/argoproj/argo-workflows
          - .
        workingDir: /work # Working directory
        resources: # Adjust resources as needed
          requests:
            cpu: "1"
            memory: 2Gi
        volumeMounts: # Shared volume mounts between tasks
          - name: work
            mountPath: /work
    - name: setup-k3s
      inputs:
        parameters:
          - name: test
          - name: install_k3s_version
          - name: profile
          - name: use-api
      outputs: {}
      metadata: {}
      container:
        name: ""
        image: ubuntu:latest
        command:
          - sh
          - "-c"
        args:
          - >
            echo "Installing k3s version: {{inputs.parameters.install_k3s_version}}" 

            echo "Running test: {{inputs.parameters.test}}"

            echo "Profile: {{inputs.parameters.profile}}"

            echo "Use API: {{inputs.parameters.use-api}}"

            DEBIAN_FRONTEND=noninteractive 

            echo "Installing dependencies..."

            apt-get update && apt-get install -y curl apt-transport-https
            ca-certificates gnupg lsb-release sudo socat

            echo "Installing kubectl..."

            curl -LO "https://dl.k8s.io/release/$(curl -L -s
            https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"

            chmod +x kubectl

            mv kubectl /usr/local/bin/

            echo "Downloading and configuring Docker..."

            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg
            --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

            echo "deb [arch=amd64
            signed-by=/usr/share/keyrings/docker-archive-keyring.gpg]
            https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
            | tee /etc/apt/sources.list.d/docker.list > /dev/null

            apt-get update && apt-get install -y docker-ce docker-ce-cli
            containerd.io

            echo "Waiting for Docker daemon to be ready..."

            until docker info; do sleep 3; done

            if ! echo {{inputs.parameters.install_k3s_version}} | egrep
            '^v[0-9]+\.[0-9]+\.[0-9]+\+k3s1$'; then
              export INSTALL_K3S_VERSION=v1.31.0+k3s1
            else
              export INSTALL_K3S_VERSION={{inputs.parameters.install_k3s_version}}
            fi

            curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=stable \
              INSTALL_K3S_EXEC="--docker --kubelet-arg=config=/work/test/e2e/manifests/kubelet-configuration.yaml" \
              K3S_KUBECONFIG_MODE=644 \
              sh -
            until kubectl --kubeconfig=/etc/rancher/k3s/k3s.yaml cluster-info ;
            do sleep 10s ; done

            cp /etc/rancher/k3s/k3s.yaml /work/.kubeconfig

            echo "- name: fake_token_user" >> /work/.kubeconfig

            echo "  user:" >> /work/.kubeconfig

            echo "    token: xxxxxx" >> /work/.kubeconfig

            until kubectl cluster-info ; do sleep 10s ; done
        workingDir: /work/
        env:
          - name: DOCKER_HOST
            value: tcp://localhost:2375
        resources:
          requests:
            cpu: "10"
            memory: 10Gi
        volumeMounts:
          - name: work
            mountPath: /work
      sidecars:
        - name: dind
          image: docker:20.10-dind
          env:
            - name: DOCKER_TLS_CERTDIR
          resources: {}
          securityContext:
            privileged: true
          mirrorVolumeMounts: true
  entrypoint: e2e-tests
  arguments:
    parameters:
      - name: repo
        value: https://github.com/argoproj/argo-workflows.git # Repository URL
      - name: branch
        value: refs/heads/main # Branch name from the webhook payload (e.g., refs/heads/main, refs/heads/feature-branch)
      - name: test-matrix
        value: |
          [
            {
              "test": "test-executor",
              "install_k3s_version": "v1.31.0+k3s1",
              "profile": "minimal",
              "use-api": false
            },
            {
              "test": "test-corefunctional",
              "install_k3s_version": "v1.31.0+k3s1",
              "profile": "minimal",
              "use-api": false
            },
            {
              "test": "test-functional",
              "install_k3s_version": "v1.31.0+k3s1",
              "profile": "minimal",
              "use-api": false
            },
            {
              "test": "test-api",
              "install_k3s_version": "v1.31.0+k3s1",
              "profile": "mysql",
              "use-api": true
            },
            {
              "test": "test-cli",
              "install_k3s_version": "v1.31.0+k3s1",
              "profile": "mysql",
              "use-api": true
            },
            {
              "test": "test-cron",
              "install_k3s_version": "v1.31.0+k3s1",
              "profile": "minimal",
              "use-api": false
            },
            {
              "test": "test-examples",
              "install_k3s_version": "v1.31.0+k3s1",
              "profile": "minimal",
              "use-api": false
            },
            {
              "test": "test-plugins",
              "install_k3s_version": "v1.31.0+k3s1",
              "profile": "plugins",
              "use-api": false
            },
            {
              "test": "test-java-sdk",
              "install_k3s_version": "v1.31.0+k3s1",
              "profile": "minimal",
              "use-api": true
            },
            {
              "test": "test-python-sdk",
              "install_k3s_version": "v1.31.0+k3s1",
              "profile": "minimal",
              "use-api": true
            },
            {
              "test": "test-executor",
              "install_k3s_version": "v1.28.13+k3s1",
              "profile": "minimal",
              "use-api": false
            },
            {
              "test": "test-corefunctional",
              "install_k3s_version": "v1.28.13+k3s1",
              "profile": "minimal",
              "use-api": false
            },
            {
              "test": "test-functional",
              "install_k3s_version": "v1.28.13+k3s1",
              "profile": "minimal",
              "use-api": false
            }
          ]
  serviceAccountName: argo-workflow-sa
